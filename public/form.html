<!-- form.html -->
<!DOCTYPE html>
<html>
<head>
  <title>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏™‡∏ï‡πå</title>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="logo">My storage</div>
    <div class="search">
      <input type="text" class="searchTerm" placeholder="Search">
      <button type="submit" class="searchButton">
        <i class="fa fa-search"></i>
      </button>
    </div>
    <div class="hamburger">
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
    </div>
    <nav class="nav-bar">
      <ul>
        <li><a href="form.html" class="active">Home</a></li>
        <li><a href="update.html">Update</a></li>
        <li><a href="storage.html">Storage</a></li>
        <li><a href="">About</a></li>
        <li><a href="">Contact</a></li>
      </ul>
    </nav>
  </header>

  <button id="addButton" class="fab">+</button> 

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <form id="addForm" class="form-box">
        <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h2>
        <div class="input-group">
          <i class="fas fa-flask"></i>
          <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ" required />
        </div>
        <div class="input-group">
          <i class="fas fa-atom"></i>
          <input type="text" id="formula" placeholder="‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ" required />
        </div>
        <div class="input-group">
          <i class="fas fa-tag"></i>
          <input type="text" id="type" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó" />
        </div>
        <div class="input-group">
          <i class="fas fa-box"></i>
          <input type="number" id="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" required />
        </div>
        <div class="input-group">
          <i class="fas fa-image"></i>
          <input type="text" id="image" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" />
        </div>
        <button type="submit" class="submit-btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </form>
    </div>
  </div>

  <div class="container">
    <div class="detail-panel" id="detailPanel">
      <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h2>
      <p>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î</p>
    </div>
    <div class="card-panel" id="cardPanel"></div>
  </div>

  <script>
    let chemicalsData = [];

    async function loadChemicals() {
      try {
        const res = await fetch("/api/chemicals");
        if (!res.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
        const chemicals = await res.json();
        chemicalsData = chemicals;
        renderChemicals(chemicals);
      } catch (error) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
        document.getElementById("cardPanel").innerHTML = `<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>`;
      }
    }

    function renderChemicals(chemicalList) {
      const cardPanel = document.getElementById("cardPanel");
      const detailPanel = document.getElementById("detailPanel");
      cardPanel.innerHTML = "";

      chemicalList.forEach((chem) => {
        const card = document.createElement("div");
        card.className = "chem-card";
        card.innerHTML = `
          <img src="${chem.image}" alt="${chem.name}" />
          <div class="info">
            <strong>${chem.name}</strong> 
            <p>${chem.formula}</p>
            ${chem.type ? `<span>${chem.type}</span>` : ""}
          </div>
        `;

        card.addEventListener("click", () => showChemicalDetail(chem));
        cardPanel.appendChild(card);
      });
    }

    function renderDetail(chem) {
      const detailPanel = document.getElementById("detailPanel");
      detailPanel.innerHTML = `
        <h2>${chem.name}</h2>
        <img src="${chem.image}" alt="${chem.name}" />
        <p><strong>‡∏™‡∏π‡∏ï‡∏£:</strong> ${chem.formula}</p>
        ${chem.type ? `<p><strong>‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞:</strong> ${chem.type}</p>` : ""}
        <p><strong>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì:</strong> ${chem.amount}</p>
        <div style="margin-top: 15px;">
          <button class="btn-small" onclick="editChemical('${chem.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn-small" onclick="deleteChemical('${chem.id}')">üóëÔ∏è ‡∏•‡∏ö</button>
          <button class="btn-small" onclick="window.updateAmount('${chem.id}', 1)">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
          <button class="btn-small" onclick="window.updateAmount('${chem.id}', -1)">‚ûñ ‡∏•‡∏î</button>
        </div>
      `;
    }

    async function updateAmount(id, delta) {
  try {
    const chem = chemicalsData.find(c => c.id === Number(id));
    if (!chem) return;

    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏™‡∏Å‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î‡∏™‡∏≤‡∏£"); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° alert ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

    const confirmText = delta > 0
      ? `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Ç‡∏≠‡∏á "${chem.name}" ‡∏Ç‡∏∂‡πâ‡∏ô 1 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
      : `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Ç‡∏≠‡∏á "${chem.name}" ‡∏•‡∏á 1 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;

    if (!confirm(confirmText)) return;

    if (chem.amount + delta < 0) {
      alert("‚ùå ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 0 ‡πÑ‡∏î‡πâ");
      return;
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï amount
    const res = await fetch(`http://localhost:5000/api/chemicals/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ delta })
    });

    if (!res.ok) throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");

    // ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ delta > 0 (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì)
    if (delta > 0) {
      try {
        const barcodeRes = await fetch("http://<ESP8266-IP>/scan");
        const { barcode } = await barcodeRes.json();

        await fetch("http://localhost:5000/api/barcodes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chemical_id: id,
            barcode_value: barcode
          })
        });
      } catch (barcodeErr) {
        console.warn("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏î‡πâ:", barcodeErr);
      }
    }

    const updated = await res.json();
    alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    chemicalsData = chemicalsData.map(c => c.id === id ? updated : c);
    showChemicalDetail(updated);
    renderChemicals(chemicalsData);

  } catch (err) {
    console.error(err);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
  }
}
  window.updateAmount = updateAmount;

  function showChemicalDetail(chemical) {
    const detailPanel = document.getElementById("detailPanel");
    detailPanel.innerHTML = `
      <h2>${chemical.name}</h2>
      <img src="${chemical.image}" alt="${chemical.name}" />
      <p><strong>‡∏™‡∏π‡∏ï‡∏£:</strong> ${chemical.formula}</p>
      ${chemical.type ? `<p><strong>‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞:</strong> ${chemical.type}</p>` : ""}
      <p><strong>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì:</strong> ${chemical.amount}</p>
      <div style="margin-top: 15px;">
        <button class="btn-small" onclick="editChemical('${chemical.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn-small" onclick="deleteChemical('${chemical.id}')">üóëÔ∏è ‡∏•‡∏ö</button>
        <button class="btn-small" onclick="window.updateAmount('${chemical.id}', 1)">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        <button class="btn-small" onclick="window.updateAmount('${chemical.id}', -1)">‚ûñ ‡∏•‡∏î</button>
      </div>
    `;
  }

    function searchChemicals(query) {
      const filtered = chemicalsData.filter((chem) =>
        chem.name.toLowerCase().includes(query.toLowerCase())
      );
      renderChemicals(filtered);
    }

    window.editChemical = function(id) {
      const newName = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:");
      if (newName) {
        fetch(`http://localhost:5000/api/chemicals/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: newName })
        })
        .then(() => loadChemicals())
        .catch((err) => console.error(err));
      }
    };

    window.deleteChemical = function(id) {
      if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) {
        fetch(`http://localhost:5000/api/chemicals/${id}`, {
          method: "DELETE",
        })
        .then(() => loadChemicals())
        .catch((err) => console.error(err));
      }
    };

    document.getElementById("addForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const formula = document.getElementById("formula").value;
      const type = document.getElementById("type").value;
      const amount = parseInt(document.getElementById("amount").value);
      const image = document.getElementById("image").value;

      try {
        const res = await fetch("http://localhost:5000/api/chemicals", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, formula, type, amount, image })
        });

        if (!res.ok) throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");

        alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
        document.getElementById("modal").style.display = "none";
        loadChemicals();
      } catch (err) {
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        console.error(err);
      }
    });

    document.getElementById("addButton").addEventListener("click", () => {
      document.getElementById("modal").style.display = "block";
    });

    document.getElementById("closeModal").addEventListener("click", () => {
      document.getElementById("modal").style.display = "none";
    });

    window.addEventListener("click", (e) => {
      if (e.target == document.getElementById("modal")) {
        document.getElementById("modal").style.display = "none";
      }
    });

    document.querySelector(".searchTerm").addEventListener("input", (e) => {
      searchChemicals(e.target.value);
    });

    document.querySelector(".hamburger").onclick = function () {
      document.querySelector(".nav-bar").classList.toggle("active");
    };

    window.addEventListener("DOMContentLoaded", loadChemicals);
  </script>
</body>
</html>
